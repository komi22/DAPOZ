case_id: CASE-STAGING-T1105-4688
threat_type: STAGING
threat_type_kr: 대량 스테이징(데이터 탈취 준비)
technique_id: T1105
technique_name_kr: (Ingress Tool Transfer)
event_ids: [4688]
log_fields: |
  New Process Name
  New Process ID
  Process Command Line
log_reason: |
  Ingress Tool Transfer 위협을 직접적으로 포착할 수 있는 이벤트이다.
  Process Name, Process ID를 봤을 때 System32 내장 도구가 비정상 URL(외부 C2 서버)로 연결되면 의심 악성 도구 다운로드를 확인할 수 있어서 Ingress Tool Transfer 행위를 의심할 수 있다.
  Process Name과 Command Line 항목을 봤을 때 certutil.exe/bitsadmin.exe와 URL 파라미터가 확인되면 의심 Ingress Tool Transfer를 확인할 수 있어서 대량 스테이징 가능성을 의심할 수 있다.
log_scenario: |
  새로운 프로세스가 생성될 때마다 발생된다.
  특히 certutil.exe, bitsadmin.exe, powershell.exe 등 내장 도구를 이용해 외부 URL에서 파일을 다운로드하는 명령어가 실행될 때 생성된다.
  이는 정상적인 소프트웨어 업데이트나 관리 작업에서도 발생하나, Ingress Tool Transfer 위협 탐지 시 확인해야 하는 핵심 이벤트 로그이다.
summary: |
  공격자가 외부 시스템에서 손상된 환경으로 공격 도구 또는 기타 파일을 전송한다.
  도구나 파일은 명령 및 제어 채널이나 FTP 와 같은 대체 프로토콜을 통해 외부 공격자가 제어하는 시스템에서 피해자 네트워크로 복사될 수 있다 .
  공격자는 감염된 환경 내에서 피해자 장치 간에 도구를 전송/확산할 수 있다.
policy_direction: |
  Ingress Tool Transfer를 막기 위해서는 외부에서 내부로 파일이 다운로드되는 경로를 최소화하고, 시스템에 기본 내장된 다운로드 기능(certutil, bitsadmin, PowerShell iwr/wget 등)을 통한 도구 반입을 통제해야 한다.
  공격자는 주로 LOLBins을 이용해 외부 C2 서버에서 악성 페이로드를 내려받으므로, 명령 실행 도구 및 파일 다운로드 기능을 제한해 초기 스테이징 자체가 이루어지지 않도록 해야 한다.
  또한 임시 폴더·사용자 프로필 경로·AppData 같은 장소에 임의 파일이 저장되지 않도록 파일 시스템 권한을 강화하면 악성 파일 반입 후 확산을 어렵게 할 수 있다.
  핵심은 다운로드 경로 통제, LOLBins 제한, 파일 저장 권한 최소화이다.
steps:
  - title: AppLocker 관련 설정
    details: |
      AppLocker 또는 WDAC 정책을 적용해 certutil.exe, bitsadmin.exe, powershell.exe, curl.exe, rundll32.exe 등 외부 다운로드에 악용되는 실행 파일의 사용을 차단하거나 특정 관리자 계정만 실행하도록 제한한다
      
      wf.msc(고급 방화벽)에서 아웃바운드 규칙을 생성해 비업무 프로세스(예: cmd, powershell, wscript)가 외부 HTTP/HTTPS로 나가는 연결을 기본 차단하여 외부 파일 다운로드 경로를 근본적으로 없앤다
      
      또한 C:\\Users\\<User>\\AppData, Temp, Downloads 등의 경로에 대한 NTFS 권한을 조정해 일반 사용자가 실행 파일을 생성·저장·실행하지 못하게 구성하면 악성 파일 스테이징이 크게 어려워진다
  - title: 상세 설정
    details: |
      마지막으로 Office·브라우저의 보안 설정을 강화해 외부 URL 기반 자동 다운로드(iwr, mshta, script loader)가 트리거되지 않도록 자동 실행 기능을 비활성화한다
operations_guidance: |
  ## 모니터링 팁
  - Event ID 4688에서 New Process Name 필드를 주의 깊게 확인하세요.
  - 비정상적인 패턴이나 짧은 시간 내 반복적인 접근을 모니터링하세요.
  - (Ingress Tool Transfer) 기법과 관련된 활동을 주의 깊게 관찰하세요.

  ## 오탐 가능성
  - 정상적인 시스템 관리 작업에서도 해당 이벤트가 발생할 수 있습니다.
  - 예약된 작업이나 백업 프로세스에 의한 정상 활동을 구분해야 합니다.

  ## 대응 방법
  - 관리자 작업은 사전 승인 프로세스를 적용하세요.
  - 예약된 작업은 화이트리스트로 등록하세요.
references:
  - title: MITRE ATT&CK - T1105
    url: https://attack.mitre.org/techniques/T1105/
  - title: Microsoft Event ID 4688
    url: https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688
